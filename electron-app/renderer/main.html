<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼«ç”»ç¿»è¯‘å·¥å…· - æ¡Œé¢ç‰ˆ</title>
    
    <!-- åŸºç¡€æ ·å¼ -->
    <link rel="stylesheet" href="static/css/modern-theme.css">
    <link rel="stylesheet" href="static/css/viewer.css">
    
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <!-- Electroné€‚é…å™¨ -->
    <script src="js/adapters/EnvironmentDetector.js"></script>
    <script src="js/adapters/FileAPIAdapter.js"></script>
    <script src="js/adapters/ElectronBridge.js"></script>
    <script src="js/adapters/AdapterManager.js"></script>
    
    <style>
        /* Electronç‰¹å®šæ ·å¼ */
        .electron-titlebar {
            height: 30px;
            background: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            font-size: 14px;
            -webkit-app-region: drag;
        }
        
        .electron-titlebar .window-controls {
            -webkit-app-region: no-drag;
            display: flex;
            gap: 10px;
        }
        
        .electron-titlebar .window-controls button {
            background: none;
            border: none;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .electron-titlebar .window-controls button:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .electron-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #67c23a;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 9999;
        }
        
        .web-status {
            background: #e6a23c;
        }
        
        .main-content {
            height: calc(100vh - 30px);
            overflow: hidden;
        }
        
        .file-drop-zone {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .file-drop-zone.dragover {
            border-color: #409eff;
            background-color: #f0f9ff;
        }
        
        .electron-features {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .feature-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        
        .feature-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Electronæ ‡é¢˜æ  -->
        <div class="electron-titlebar" v-if="isElectron">
            <span>ğŸŒ æ¼«ç”»ç¿»è¯‘å·¥å…· - æ¡Œé¢ç‰ˆ</span>
            <div class="window-controls">
                <button @click="minimizeWindow">âˆ’</button>
                <button @click="maximizeWindow">â–¡</button>
                <button @click="closeWindow">Ã—</button>
            </div>
        </div>
        
        <!-- ç¯å¢ƒçŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div :class="['electron-status', { 'web-status': !isElectron }]">
            {{ isElectron ? 'âš¡ Electron' : 'ğŸŒ Web' }}
        </div>
        
        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <div class="container" style="padding: 20px;">
                <h1 style="text-align: center; margin-bottom: 30px;">
                    ğŸŒ æ¼«ç”»ç¿»è¯‘å·¥å…· - æ¡Œé¢ç‰ˆ
                </h1>
                
                <!-- Electronç‰¹æœ‰åŠŸèƒ½å±•ç¤º -->
                <div class="electron-features" v-if="isElectron">
                    <h3>ğŸš€ æ¡Œé¢ç‰ˆç‰¹æœ‰åŠŸèƒ½</h3>
                    <div class="feature-grid">
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ“</div>
                            <h4>ç›´æ¥æ–‡ä»¶é€‰æ‹©</h4>
                            <p>æ— éœ€ä¸Šä¼ ï¼Œç›´æ¥é€‰æ‹©æœ¬åœ°æ–‡ä»¶</p>
                            <el-button @click="testFileSelection" size="small">æµ‹è¯•</el-button>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ“‚</div>
                            <h4>æ–‡ä»¶å¤¹æ‰¹é‡å¤„ç†</h4>
                            <p>ä¸€æ¬¡æ€§å¤„ç†æ•´ä¸ªæ–‡ä»¶å¤¹</p>
                            <el-button @click="testDirectorySelection" size="small">æµ‹è¯•</el-button>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ”„</div>
                            <h4>åŸåœ°æ–‡ä»¶æ›¿æ¢</h4>
                            <p>ç›´æ¥æ›¿æ¢åŸå§‹æ–‡ä»¶</p>
                            <el-button @click="showReplaceDemo" size="small">æ¼”ç¤º</el-button>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ””</div>
                            <h4>ç³»ç»Ÿé€šçŸ¥</h4>
                            <p>åŸç”Ÿç³»ç»Ÿé€šçŸ¥æ”¯æŒ</p>
                            <el-button @click="testNotification" size="small">æµ‹è¯•</el-button>
                        </div>
                    </div>
                </div>
                
                <!-- æ–‡ä»¶æ‹–æ”¾åŒºåŸŸ -->
                <div class="file-drop-zone" 
                     @dragover.prevent="handleDragOver"
                     @dragleave.prevent="handleDragLeave"
                     @drop.prevent="handleFileDrop"
                     :class="{ 'dragover': isDragOver }">
                    <div v-if="isElectron">
                        <h3>ğŸ“ æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œ</h3>
                        <p>æ”¯æŒæ¼«ç”»æ–‡ä»¶ (.zip, .rar, .cbz, .cbr)</p>
                        <p>æˆ–è€…ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶</p>
                    </div>
                    <div v-else>
                        <h3>ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</h3>
                        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶ä¸Šä¼ </p>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div style="text-align: center; margin: 30px 0;">
                    <el-button-group>
                        <el-button type="primary" @click="selectFiles" size="large">
                            ğŸ“ {{ isElectron ? 'é€‰æ‹©æ–‡ä»¶' : 'ä¸Šä¼ æ–‡ä»¶' }}
                        </el-button>
                        <el-button type="success" @click="selectMultipleFiles" size="large" v-if="isElectron">
                            ğŸ“‚ æ‰¹é‡é€‰æ‹©
                        </el-button>
                        <el-button type="info" @click="openWebVersion" size="large" v-if="isElectron">
                            ğŸŒ Webç‰ˆæœ¬
                        </el-button>
                    </el-button-group>
                </div>
                
                <!-- é€‰ä¸­çš„æ–‡ä»¶åˆ—è¡¨ -->
                <div v-if="selectedFiles.length > 0" style="margin-top: 30px;">
                    <h3>ğŸ“‹ é€‰ä¸­çš„æ–‡ä»¶ ({{ selectedFiles.length }})</h3>
                    <el-table :data="selectedFiles" style="width: 100%">
                        <el-table-column prop="name" label="æ–‡ä»¶å" />
                        <el-table-column prop="size" label="å¤§å°" :formatter="formatFileSize" />
                        <el-table-column prop="type" label="ç±»å‹" />
                        <el-table-column label="æ“ä½œ" width="200">
                            <template #default="scope">
                                <el-button @click="removeFile(scope.$index)" size="small" type="danger">
                                    åˆ é™¤
                                </el-button>
                                <el-button @click="showInFolder(scope.row)" size="small" v-if="isElectron && scope.row.path">
                                    å®šä½
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <el-button type="primary" @click="startTranslation" size="large">
                            ğŸš€ å¼€å§‹ç¿»è¯‘
                        </el-button>
                        <el-button @click="clearFiles" size="large">
                            ğŸ§¹ æ¸…ç©ºåˆ—è¡¨
                        </el-button>
                    </div>
                </div>
                
                <!-- PythonæœåŠ¡çŠ¶æ€ -->
                <div style="margin-top: 30px;">
                    <el-card>
                        <template #header>
                            <span>ğŸ PythonæœåŠ¡çŠ¶æ€</span>
                            <el-button style="float: right;" @click="refreshPythonStatus" size="small">
                                åˆ·æ–°
                            </el-button>
                        </template>
                        <div v-if="pythonStatus">
                            <p><strong>çŠ¶æ€:</strong> 
                                <el-tag :type="pythonStatus.isRunning ? 'success' : 'danger'">
                                    {{ pythonStatus.isRunning ? 'è¿è¡Œä¸­' : 'æœªè¿è¡Œ' }}
                                </el-tag>
                            </p>
                            <p v-if="pythonStatus.port"><strong>ç«¯å£:</strong> {{ pythonStatus.port }}</p>
                            <p v-if="pythonStatus.pid"><strong>è¿›ç¨‹ID:</strong> {{ pythonStatus.pid }}</p>
                        </div>
                        <div v-else>
                            <p>è·å–çŠ¶æ€ä¸­...</p>
                        </div>
                    </el-card>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    isElectron: false,
                    selectedFiles: [],
                    isDragOver: false,
                    pythonStatus: null,
                    adaptersReady: false
                };
            },
            
            async mounted() {
                // ç­‰å¾…é€‚é…å™¨å°±ç»ª
                window.addEventListener('adapters-ready', this.onAdaptersReady);
                window.addEventListener('adapters-error', this.onAdaptersError);
                
                // æ£€æµ‹ç¯å¢ƒ
                this.isElectron = EnvironmentDetector.isElectron();
                
                // å¦‚æœé€‚é…å™¨å·²ç»å°±ç»ªï¼Œç«‹å³åˆå§‹åŒ–
                if (window.adapterManager && window.adapterManager.isReady()) {
                    this.onAdaptersReady();
                }
            },
            
            methods: {
                onAdaptersReady() {
                    this.adaptersReady = true;
                    ElMessage.success('é€‚é…å™¨åˆå§‹åŒ–å®Œæˆ');
                    this.refreshPythonStatus();
                },
                
                onAdaptersError(event) {
                    ElMessage.error(`é€‚é…å™¨åˆå§‹åŒ–å¤±è´¥: ${event.detail.error}`);
                },
                
                async selectFiles() {
                    try {
                        if (this.isElectron) {
                            const result = await window.fileAPI.selectFile({
                                accept: '.zip,.rar,.cbz,.cbr'
                            });
                            if (result) {
                                this.selectedFiles.push(result);
                                ElMessage.success(`å·²é€‰æ‹©æ–‡ä»¶: ${result.name}`);
                            }
                        } else {
                            // Webç¯å¢ƒçš„æ–‡ä»¶é€‰æ‹©é€»è¾‘
                            const result = await window.fileAPI.selectFile({
                                accept: '.zip,.rar,.cbz,.cbr'
                            });
                            if (result) {
                                this.selectedFiles.push(result);
                                ElMessage.success(`å·²é€‰æ‹©æ–‡ä»¶: ${result.name}`);
                            }
                        }
                    } catch (error) {
                        ElMessage.error(`æ–‡ä»¶é€‰æ‹©å¤±è´¥: ${error.message}`);
                    }
                },
                
                async selectMultipleFiles() {
                    try {
                        const results = await window.fileAPI.selectMultipleFiles({
                            accept: '.zip,.rar,.cbz,.cbr'
                        });
                        if (results && results.length > 0) {
                            this.selectedFiles.push(...results);
                            ElMessage.success(`å·²é€‰æ‹© ${results.length} ä¸ªæ–‡ä»¶`);
                        }
                    } catch (error) {
                        ElMessage.error(`å¤šæ–‡ä»¶é€‰æ‹©å¤±è´¥: ${error.message}`);
                    }
                },
                
                async testFileSelection() {
                    await this.selectFiles();
                },
                
                async testDirectorySelection() {
                    try {
                        const result = await window.fileAPI.selectDirectory();
                        if (result) {
                            ElMessage.success(`å·²é€‰æ‹©æ–‡ä»¶å¤¹: ${result.name}`);
                        }
                    } catch (error) {
                        ElMessage.error(`æ–‡ä»¶å¤¹é€‰æ‹©å¤±è´¥: ${error.message}`);
                    }
                },
                
                showReplaceDemo() {
                    ElMessageBox.alert(
                        'åŸåœ°æ–‡ä»¶æ›¿æ¢åŠŸèƒ½å…è®¸ç›´æ¥æ›¿æ¢åŸå§‹æ¼«ç”»æ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†æ–‡ä»¶ã€‚ç¿»è¯‘å®Œæˆåï¼Œæ‚¨å¯ä»¥é€‰æ‹©ï¼š\n\n1. æ›¿æ¢åŸæ–‡ä»¶\n2. ä¿å­˜ä¸ºæ–°æ–‡ä»¶\n3. åˆ›å»ºå¤‡ä»½åæ›¿æ¢',
                        'åŸåœ°æ–‡ä»¶æ›¿æ¢æ¼”ç¤º',
                        { type: 'info' }
                    );
                },
                
                async testNotification() {
                    try {
                        await window.electronBridge.showNotification(
                            'æµ‹è¯•é€šçŸ¥',
                            'è¿™æ˜¯æ¥è‡ªæ¼«ç”»ç¿»è¯‘å·¥å…·çš„æµ‹è¯•é€šçŸ¥'
                        );
                        ElMessage.success('é€šçŸ¥å·²å‘é€');
                    } catch (error) {
                        ElMessage.error(`é€šçŸ¥å‘é€å¤±è´¥: ${error.message}`);
                    }
                },
                
                handleDragOver(event) {
                    this.isDragOver = true;
                },
                
                handleDragLeave(event) {
                    this.isDragOver = false;
                },
                
                handleFileDrop(event) {
                    this.isDragOver = false;
                    
                    if (!this.isElectron) {
                        ElMessage.warning('Webç‰ˆæœ¬ä¸æ”¯æŒæ‹–æ”¾ï¼Œè¯·ä½¿ç”¨æ–‡ä»¶é€‰æ‹©');
                        return;
                    }
                    
                    // Electronç¯å¢ƒä¸‹çš„æ–‡ä»¶æ‹–æ”¾å¤„ç†
                    const files = Array.from(event.dataTransfer.files);
                    const validFiles = files.filter(file => 
                        ['.zip', '.rar', '.cbz', '.cbr'].some(ext => 
                            file.name.toLowerCase().endsWith(ext)
                        )
                    );
                    
                    if (validFiles.length > 0) {
                        this.selectedFiles.push(...validFiles.map(file => ({
                            file: file,
                            name: file.name,
                            size: file.size,
                            type: file.type || 'application/octet-stream',
                            path: file.path // Electronæä¾›çš„çœŸå®è·¯å¾„
                        })));
                        ElMessage.success(`å·²æ·»åŠ  ${validFiles.length} ä¸ªæ–‡ä»¶`);
                    } else {
                        ElMessage.warning('è¯·æ‹–æ”¾æœ‰æ•ˆçš„æ¼«ç”»æ–‡ä»¶');
                    }
                },
                
                removeFile(index) {
                    this.selectedFiles.splice(index, 1);
                    ElMessage.info('æ–‡ä»¶å·²ç§»é™¤');
                },
                
                async showInFolder(file) {
                    if (file.path) {
                        try {
                            await window.fileAPI.showItemInFolder(file.path);
                        } catch (error) {
                            ElMessage.error(`æ— æ³•å®šä½æ–‡ä»¶: ${error.message}`);
                        }
                    }
                },
                
                clearFiles() {
                    this.selectedFiles = [];
                    ElMessage.info('æ–‡ä»¶åˆ—è¡¨å·²æ¸…ç©º');
                },
                
                startTranslation() {
                    if (this.selectedFiles.length === 0) {
                        ElMessage.warning('è¯·å…ˆé€‰æ‹©è¦ç¿»è¯‘çš„æ–‡ä»¶');
                        return;
                    }
                    
                    ElMessage.info('ç¿»è¯‘åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
                    // TODO: å®ç°ç¿»è¯‘åŠŸèƒ½
                },
                
                async refreshPythonStatus() {
                    try {
                        this.pythonStatus = await window.electronBridge.getPythonStatus();
                    } catch (error) {
                        ElMessage.error(`è·å–PythonçŠ¶æ€å¤±è´¥: ${error.message}`);
                    }
                },
                
                openWebVersion() {
                    if (this.pythonStatus && this.pythonStatus.port) {
                        const url = `http://127.0.0.1:${this.pythonStatus.port}`;
                        window.electronBridge.openPath ? 
                            window.electronBridge.openPath(url) :
                            window.open(url, '_blank');
                    } else {
                        ElMessage.warning('PythonæœåŠ¡æœªè¿è¡Œï¼Œæ— æ³•æ‰“å¼€Webç‰ˆæœ¬');
                    }
                },
                
                async minimizeWindow() {
                    await window.electronBridge.minimizeWindow();
                },
                
                async maximizeWindow() {
                    await window.electronBridge.maximizeWindow();
                },
                
                async closeWindow() {
                    await window.electronBridge.closeWindow();
                },
                
                formatFileSize(row, column, cellValue) {
                    if (!cellValue) return '-';
                    
                    const units = ['B', 'KB', 'MB', 'GB'];
                    let size = cellValue;
                    let unitIndex = 0;
                    
                    while (size >= 1024 && unitIndex < units.length - 1) {
                        size /= 1024;
                        unitIndex++;
                    }
                    
                    return `${size.toFixed(1)} ${units[unitIndex]}`;
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>

# `apply_diff` 工具使用经验总结

在使用 `apply_diff` 工具进行代码修改时，尤其是在删除多行代码块时，需要特别注意以下几点，以避免引入新的错误（例如缩进问题）：

1.  **删除代码块的完整性**: 当删除一个代码块（例如 `if/elif/else` 语句块、函数体、类定义等）时，务必确保该代码块内的所有相关行都被包含在 `SEARCH` 部分中。如果只删除了条件语句本身，而其内部的逻辑行被遗漏，则这些遗留的行可能会导致缩进错误或逻辑错误。

2.  **上下文敏感性**: `apply_diff` 是基于精确匹配的。在删除或替换代码时，要充分考虑被修改代码的上下文。如果删除了一部分代码，导致其后续行的缩进不再符合 Python 语法规范，就会引发 `意外缩进` 等 Pylance 错误。

3.  **及时检查 Linter 错误**: 在每次使用 `apply_diff` 或其他文件修改工具后，应立即检查 VS Code 或其他开发环境中报告的 Linter 错误。这些错误通常能及时指出语法或格式问题，例如缩进不正确。

**案例回顾**:

在本次任务中，尝试删除 `ui/new_interface/manga_viewer.py` 中与 NLLB 相关的条件判断时，最初只删除了 `if current_translator_engine == "NLLB":` 这一行。这导致其内部的 `source_lang = config.nllb_source_lang.value` 和 `target_lang = config.nllb_target_lang.value` 行失去了正确的缩进上下文，从而引发了 Pylance 的 `意外缩进` 错误。

**解决方案**:

通过再次使用 `search_and_replace` 工具，将遗留的 `target_lang = config.nllb_target_lang.value` 行也一并删除，最终解决了缩进问题。

**总结**:

`apply_diff` 是一个强大的工具，但需要谨慎使用。在进行多行删除或复杂修改时，建议：
*   **预先仔细审查**: 在执行 `apply_diff` 之前，仔细审查要删除或修改的代码块，确保所有相关行都被正确识别。
*   **小步快跑**: 对于复杂的修改，可以考虑分多次 `apply_diff`，每次处理一个相对独立的逻辑单元，这样更容易定位和修复问题。
*   **利用工具反馈**: 密切关注工具执行后的反馈，特别是 Linter 错误信息，它们是发现和解决问题的关键线索。
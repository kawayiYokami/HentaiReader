# 核心架构文档

本文档旨在详细分析漫画翻译器项目的核心架构，总结每个文件、类和方法的职责与功能。

---

## `core` 模块概览

`core` 模块包含了漫画翻译应用程序的核心业务逻辑，包括漫画管理、OCR（光学字符识别）、翻译、缓存、图像处理和配置管理。

### 文件: [`core/batch_translation_worker.py`](core/batch_translation_worker.py)

此文件定义了用于处理漫画批量翻译任务的类。

#### 类: [`TranslationTaskItem`](core/batch_translation_worker.py:16)
- **描述**: 表示一个独立的翻译任务项，通常对应一张图片。它封装了图片翻译所需的所有相关信息，如输入/输出路径、语言、是否来自压缩包、页码以及图片数据本身。
- **属性**:
    - `task_id` (Any): 任务的唯一标识符（例如 "row0_img1"）。
    - `input_path` (Optional[str]): 待翻译图片的原始路径。如果提供了 `image_data`，则此字段可选并被忽略。
    - `output_path` (Optional[str]): 翻译后图片（PNG格式）的临时保存路径。在 `save_to_disk` 为 `True` 时，此路径位于 `batch_png_output_temp_dir` 内。
    - `source_lang` (str): 源语言代码，默认 "auto"。
    - `target_lang` (str): 目标语言代码，默认 "zh-CN"。
    - `is_archive` (bool): 标记图片是否来自压缩包。
    - `original_archive_path` (Optional[str]): 如果 `is_archive` 为 `True`，记录原始压缩包的路径。
    - `page_index` (Optional[int]): 图片在漫画中的页码，用于缓存机制。
    - `image_data` (Optional[np.ndarray]): 待翻译图片的原始数据（NumPy 数组）。如果提供，则优先使用。
    - `status` (str): 任务的当前状态，用于UI显示，默认 "待处理"。
    - `error_message` (Optional[str]): 任务失败时存储的错误信息。

#### 类: [`BatchTranslationWorker`](core/batch_translation_worker.py:49)
- **描述**: 这是一个继承自 `PySide6.QtCore.QObject` 的工作线程，负责执行图片翻译和最终打包任务。它通过信号与UI进行通信，报告任务进度和结果。
- **信号 (Signals)**:
    - `task_started` (object): 当单个翻译任务开始时发射，携带 `task_id`。
    - `task_progress` (object, int, str): 发送单个任务的进度信息（`task_id`, 百分比, 消息），当前版本暂未使用。
    - `task_finished` (object, bool, str): 当单个翻译任务完成时发射，携带 `task_id`、任务是否成功（`True`/`False`）和结果消息。
    - `overall_progress` (int, str): 发送整个批量翻译任务的总体进度（百分比, 消息）。
    - `all_tasks_finished` (str): 当所有任务完成时发射，携带最终结果消息（例如ZIP文件路径或错误信息）。
    - `log_message` (str): 发送日志信息到UI进行显示。
    - `single_page_translated` (int, object): 当单页翻译完成时发射，携带 `page_index` 和翻译后的图片数据 (`translated_image_data`)。
    - `error_occurred` (str): 当发生任何错误时发射，携带错误信息。
- **方法**:
    - `set_task_list(self, tasks: List[TranslationTaskItem])`:
        - **职责**: 动态更新批量翻译的工作任务列表。
        - **参数**: `tasks` (List[[`TranslationTaskItem`](core/batch_translation_worker.py:16)]): 新的任务列表。
### 文件: [`core/cache_factory.py`](core/cache_factory.py)

此文件定义了 [`CacheManagerFactory`](core/cache_factory.py:12) 类，它是一个单例工厂，负责创建和管理不同类型的缓存管理器实例。

#### 类: [`CacheManagerFactory`](core/cache_factory.py:12)
- **描述**: 一个单例工厂类，用于提供各种缓存管理器的实例，包括漫画列表缓存、OCR缓存和翻译缓存。它确保每种类型的缓存管理器只有一个实例被创建和使用，从而实现资源的有效管理和共享。
- **方法**:
    - `get_cache_manager(self, cache_type: str, *args, **kwargs) -> CacheInterface`:
        - **职责**: 根据指定的缓存类型获取对应的缓存管理器实例。如果该类型的缓存管理器尚未创建，则会创建一个新实例并缓存起来。
        - **参数**:
            - `cache_type` (str): 缓存类型，可以是 "manga_list"、"ocr_cache" 或 "translation_cache"。
            - `*args`, `**kwargs`: 可选参数，会直接传递给所请求缓存管理器的构造函数。
        - **逻辑**:
            1. 首先检查 `cache_type` 是否已存在于内部的 `_cache_instances` 字典中。
            2. 如果不存在，则根据 `cache_type` 的值动态创建相应的缓存管理器实例：
                - "manga_list": 创建 [`MangaListCacheManager`](core/manga_cache.py:17) 的实例。
                - "ocr_cache": 创建 [`OcrCacheManager`](core/ocr_cache_manager.py:16) 的实例。
                - "translation_cache": 创建 [`TranslationCacheManager`](core/translation_cache_manager.py:16) 的实例。
                - 对于任何其他未知的 `cache_type`，会抛出 `ValueError`。
            3. 将新创建的实例存储在 `_cache_instances` 中，以确保后续对相同 `cache_type` 的请求返回相同的单例。
            4. 返回对应类型的缓存管理器实例。
    - `clear_cache(self, cache_type: Optional[str] = None)`:
        - **职责**: 清除指定类型或所有缓存管理器的数据。
        - **参数**:
            - `cache_type` (Optional[str]): 要清除的缓存类型字符串。如果为 `None`，则清除所有已知的缓存管理器数据。
        - **逻辑**:
            1. 如果 `cache_type` 为 `None`，则遍历 `_cache_instances` 中的所有缓存管理器，并对每个管理器调用其 `clear()` 方法。
            2. 如果指定了 `cache_type`，则仅对该特定类型的缓存管理器调用 `clear()` 方法。
            3. 清除操作会被记录到日志中。
### 文件: [`core/cache_interface.py`](core/cache_interface.py)

此文件定义了 [`CacheInterface`](core/cache_interface.py:12) 抽象基类 (ABC)，为所有缓存管理器提供了统一的接口，确保了不同缓存实现之间的一致性。

#### 抽象基类: [`CacheInterface`](core/cache_interface.py:12)
- **描述**: 这是一个抽象基类，定义了所有具体缓存管理器（如 [`MangaListCacheManager`](core/manga_cache.py:17)、[`OcrCacheManager`](core/ocr_cache_manager.py:16) 和 [`TranslationCacheManager`](core/translation_cache_manager.py:16)）必须实现的基本操作和方法签名。通过定义此接口，可以确保不同的缓存实现具有一致的行为和可互换性。
- **方法**:
### 文件: [`core/config.py`](core/config.py)

此文件定义了应用程序的配置管理类 [`Config`](core/config.py:12)，它继承自 `qfluentwidgets.QConfig`，用于管理应用程序的各种设置，并提供持久化存储。

#### 类: [`Config`](core/config.py:12)
- **描述**: `Config` 类是应用程序的全局配置中心。它利用 `qfluentwidgets.QConfig` 的能力，将应用程序的各项设置（如阅读顺序、显示模式、翻译引擎类型、API 密钥、OCR 阈值、图片压缩质量、代理设置、各种缓存目录、字体设置、图像修复参数以及 OCR 模型路径等）进行持久化存储。这意味着用户的所有配置更改都将在应用程序重启后保持不变。
- **方法**:
- **配置项 (Properties)**:
    - `reading_order` (ConfigItem): 控制漫画的阅读方向（例如“从左到右”或“从右到右”）。
    - `display_mode` (ConfigItem): 定义漫画的显示方式（例如“单页”或“双页”）。
    - `translator_type` (ConfigItem): 指定当前使用的翻译引擎类型（例如“智谱”或“Google”）。
    - `zhipu_api_key` (ConfigItem): 智谱AI翻译服务的API密钥。
    - `google_api_key` (ConfigItem): Google翻译服务的API密钥。
    - `ocr_threshold` (ConfigItem): OCR识别的置信度阈值。
    - `image_quality` (ConfigItem): 图片压缩时的质量设置。
    - `proxy_address` (ConfigItem): 用于网络请求的代理服务器地址。
    - `proxy_port` (ConfigItem): 代理服务器的端口。
    - `translation_cache_dir` (ConfigItem): 翻译结果的缓存目录路径。
    - `ocr_cache_dir` (ConfigItem): OCR识别结果的缓存目录路径。
    - `manga_list_cache_dir` (ConfigItem): 漫画列表扫描结果的缓存目录路径。
    - `harmonization_map_file` (ConfigItem): 文本和谐映射文件的路径。
    - `batch_png_output_temp_dir` (ConfigItem): 批量翻译过程中临时PNG输出文件的存储目录。
    - `translated_archive_output_dir` (ConfigItem): 翻译后的漫画压缩包的输出目录。
    - `font_path` (ConfigItem): 用于在翻译图片上绘制文本的字体文件路径。
    - `font_size` (ConfigItem): 绘制文本的字体大小。
    - `text_color` (ConfigItem): 绘制文本的颜色。
    - `stroke_color` (ConfigItem): 绘制文本描边的颜色。
    - `stroke_width` (ConfigItem): 绘制文本描边的宽度。
    - `enable_inpaint` (ConfigItem): 布尔值，指示是否启用图像修复功能（用于去除原始文本）。
    - `inpaint_strength` (ConfigItem): 图像修复的强度。
    - `inpaint_padding` (ConfigItem): 图像修复时的内边距。
    - `inpaint_margin` (ConfigItem): 图像修复时的外边距。
    - `ocr_paddle_model_path` (ConfigItem): PaddleOCR模型的根路径。
    - `ocr_paddle_rec_path` (ConfigItem): PaddleOCR识别模型的路径。
    - `ocr_paddle_det_path` (ConfigItem): PaddleOCR检测模型的路径。
    - `ocr_paddle_cls_path` (ConfigItem): PaddleOCR分类模型的路径。
    - `ocr_paddle_keys_path` (ConfigItem): PaddleOCR键文件路径。
    - `ocr_paddle_use_gpu` (ConfigItem): 布尔值，指示 PaddleOCR 是否使用GPU进行计算。
    - `ocr_paddle_gpu_id` (ConfigItem): PaddleOCR使用的GPU设备ID。
### 文件: [`core/data_models.py`](core/data_models.py)

此文件定义了应用程序中使用的核心数据模型，主要是 [`OCRResult`](core/data_models.py:10) 类，用于封装OCR识别的结果。

#### 类: [`OCRResult`](core/data_models.py:10)
- **描述**: `OCRResult` 是一个使用 Python `dataclasses` 模块定义的数据类，专门用于封装光学字符识别 (OCR) 过程的单个识别结果。它提供了结构化的方式来存储识别出的文本、文本在原始图片中的精确位置（边界框）、识别的置信度，以及原始图片的尺寸信息。这使得 OCR 结果的处理和传递更加方便和类型安全。
- **装饰器**: `@dataclass` - 表明这是一个数据类，自动生成 `__init__`, `__repr__`, `__eq__` 等方法。
- **属性**:
    - `text` (str): OCR 引擎识别出的文本字符串。
    - `box` (List[List[int]]): 文本的边界框坐标。通常是一个包含四个点的列表，每个点表示为 `[x, y]`，代表文本区域的左上、右上、右下、左下角。
    - `confidence` (float): OCR 识别结果的置信度分数，通常是一个介于 0.0 和 1.0 之间的浮点数，表示识别的准确程度。
    - `image_width` (int): 原始图片的宽度（像素）。
    - `image_height` (int): 原始图片的高度（像素）。
- **方法**:
### 文件: [`core/harmonization_map_manager.py`](core/harmonization_map_manager.py)

此文件定义了 [`HarmonizationMapManager`](core/harmonization_map_manager.py:12) 类，它是一个单例管理器，负责加载、保存、添加、删除和应用文本和谐映射。

#### 类: [`HarmonizationMapManager`](core/harmonization_map_manager.py:12)
- **描述**: `HarmonizationMapManager` 是一个单例类，其核心职责是管理应用程序中的文本和谐映射。这些映射允许用户定义将特定“原始文本”替换为“替换文本”的规则，这在处理敏感词、统一翻译风格或纠正特定文本输出时非常有用。管理器从 JSON 文件加载这些映射，并提供了一系列方法来动态地添加、删除和应用这些映射到文本上。
- **方法**:
### 文件: [`core/image_compressor.py`](core/image_compressor.py)

此文件定义了 [`ImageCompressor`](core/image_compressor.py:12) 类，它是一个单例管理器，负责将漫画图片压缩为 WebP 格式并重新打包成 ZIP 文件。

#### 类: [`ImageCompressor`](core/image_compressor.py:12)
- **描述**: `ImageCompressor` 是一个单例类，专注于对漫画图片进行高效的压缩处理。其主要功能是将原始图片（通常为 PNG 或 JPG 格式）转换为存储效率更高的 WebP 格式，并将其重新打包成一个新的 ZIP 压缩包。这对于减少漫画文件的存储空间占用和加快加载速度至关重要。该类设计为支持异步操作，能够向 UI 报告压缩进度，并提供任务取消功能。
- **信号 (Signals)**:
    - `compression_progress` (int, str): 发射整体压缩任务的进度信息，包括已完成的百分比和当前操作的描述消息。
    - `compression_finished` (str): 当整个压缩任务完成时发射，携带最终结果消息（例如，成功生成的 ZIP 文件路径或遇到的错误信息）。
    - `log_message` (str): 发射日志信息，用于在 UI 或控制台显示详细的操作过程。
    - `error_occurred` (str): 当压缩过程中发生任何错误时发射，携带错误描述信息。
- **方法**:
    - `compress_manga_archive(self, input_zip_path: str, output_dir: str, base_name: str, quality: int = 80)`:
        - **职责**: 执行整个漫画压缩包（ZIP文件）的压缩流程。
        - **参数**:
            - `input_zip_path` (str): 原始漫画 ZIP 文件的完整路径。
            - `output_dir` (str): 压缩完成后新的 WebP ZIP 文件的输出目录。
            - `base_name` (str): 压缩后 ZIP 文件的基础名称（不包含扩展名）。
            - `quality` (int): 可选参数，WebP 压缩的质量因子，范围从 0（最低质量）到 100（最高质量），默认为 80。
        - **逻辑**:
            1. 发射 `compression_progress` 信号，通知任务开始。
            2. 创建临时目录，用于解压原始图片和存储转换后的 WebP 图片。
            3. 调用 `_extract_images_from_zip` 方法将原始 ZIP 文件解压到临时目录。
            4. 遍历解压后的每一张图片：
                - 检查 `_is_cancelled` 标志以支持任务取消。
                - 调用 `_convert_to_webp` 方法将图片转换为 WebP 格式并保存到另一个临时目录。
                - 更新并发射 `compression_progress` 信号。
            5. 调用 `_create_output_zip` 方法将所有转换后的 WebP 图片重新打包成一个新的 ZIP 文件。
            6. 清理所有创建的临时文件和目录。
            7. 根据任务结果发射 `compression_finished` 信号。
            8. 使用 `try-except` 块捕获并处理过程中可能发生的各种异常，发射 `error_occurred` 信号。
### 文件: [`core/image_translator.py`](core/image_translator.py)

此文件定义了 [`ImageTranslator`](core/image_translator.py:12) 类，它是图片翻译的核心协调器，负责整合 OCR、文本翻译和文本绘制。

#### 类: [`ImageTranslator`](core/image_translator.py:12)
- **描述**: `ImageTranslator` 是应用程序中进行端到端图片翻译的核心协调器。它不直接执行 OCR 或翻译，而是通过聚合和编排其他专业组件（如 [`OCRManager`](core/ocr_manager.py:12)、[`TranslatorFactory`](core/translator.py:27) 创建的翻译器、[`MangaTextReplacer`](core/manga_text_replacer.py:12) 和 [`HarmonizationMapManager`](core/harmonization_map_manager.py:12)）来完成整个翻译流程。它能够处理单张图片的翻译，也支持批量图片翻译。
- **方法**:

#### 函数: [`create_image_translator(translator_type: str = "智谱") -> ImageTranslator`](core/image_translator.py:783)
- **职责**: 这是一个工厂函数，用于创建并返回一个 [`ImageTranslator`](core/image_translator.py:12) 的实例。
- **参数**: `translator_type` (str): 指定要创建的翻译器类型。
- **逻辑**: 简单地实例化 [`ImageTranslator`](core/image_translator.py:12) 类并返回。
### 文件: [`core/manga_cache.py`](core/manga_cache.py)

此文件定义了 [`MangaListCacheManager`](core/manga_cache.py:17) 类，它是一个专门用于缓存漫画文件扫描结果的管理器。

#### 类: [`MangaListCacheManager`](core/manga_cache.py:17)
- **描述**: `MangaListCacheManager` 继承自抽象基类 [`CacheInterface`](core/cache_interface.py:12)，负责管理应用程序中漫画文件（无论是 ZIP 压缩包还是普通文件夹）的扫描结果缓存。它利用 SQLite 数据库作为其持久化存储机制，将漫画目录的路径作为键，并将序列化的 [`MangaInfo`](core/manga_model.py:17) 对象作为值进行存储。这种缓存机制极大地避免了重复扫描大量漫画文件所带来的性能开销，从而提高了应用程序的启动速度和响应能力。
- **方法**:
### 文件: [`core/manga_manager.py`](core/manga_manager.py)

此文件定义了 [`MangaManager`](core/manga_manager.py:12) 类，它是应用程序中负责漫画文件扫描、加载、过滤和管理的核心组件。

#### 类: [`MangaManager`](core/manga_manager.py:12)
- **描述**: `MangaManager` 是一个单例类，负责应用程序中漫画文件的整个生命周期管理，包括从指定目录扫描漫画文件（支持 ZIP 压缩包和普通文件夹）、加载其元数据和图片，以及提供对漫画列表的过滤、排序和管理功能。它还集成了缓存机制（通过 [`MangaListCacheManager`](core/manga_cache.py:17)），以避免重复扫描和预加载，从而显著提高应用程序的性能和响应速度。
- **信号 (Signals)**:
    - `manga_scan_started = Signal()`: 当漫画扫描过程开始时发射。
    - `manga_scan_progress = Signal(int, str)`: 在漫画扫描过程中，当进度更新时发射，携带已完成的百分比和当前操作的描述消息。
    - `manga_scan_finished = Signal(list)`: 当漫画扫描完成时发射，携带一个包含所有扫描到的 [`MangaInfo`](core/manga_model.py:17) 对象的列表。
    - `manga_load_progress = Signal(int, str)`: 在漫画图片预加载过程中，当进度更新时发射，携带已完成的百分比和当前操作的描述消息。
    - `manga_load_finished = Signal(object)`: 当单个漫画的图片预加载完成时发射，携带加载完成的 [`MangaInfo`](core/manga_model.py:17) 对象。
    - `error_occurred = Signal(str)`: 当在漫画管理过程中发生任何错误时发射，携带错误描述信息。
- **方法**:
### 文件: [`core/manga_model.py`](core/manga_model.py)

此文件定义了两个核心类：[`MangaInfo`](core/manga_model.py:17) 用于表示漫画的元数据和状态，以及 [`MangaLoader`](core/manga_model.py:165) 用于加载和预处理漫画图片。

#### 类: [`MangaInfo`](core/manga_model.py:17)
- **描述**: `MangaInfo` 是一个数据类，旨在全面封装一个漫画文件的所有相关信息。这包括漫画的存储路径、标题、总页数、页面的标准尺寸（宽度和高度）、已加载到内存的图片数据缓存、以及漫画是否已完全加载和其文件类型（ZIP或文件夹）。它能够智能地从 ZIP 压缩包或普通文件夹中解析这些漫画信息。
- **装饰器**: `@dataclass` - 自动生成标准方法，简化数据模型的定义。
- **属性**:
    - `path` (str): 漫画文件的完整文件系统路径。可以是 ZIP 压缩包的路径，也可以是包含漫画图片的文件夹路径。
    - `title` (str): 漫画的标题。通常从文件或文件夹名称中提取。
    - `total_pages` (int): 漫画的总页数。
    - `width` (int): 漫画页面的标准宽度（像素）。通常取第一页的宽度。
    - `height` (int): 漫画页面的标准高度（像素）。通常取第一页的高度。
    - `loaded_images` (Dict[int, np.ndarray]): 一个字典，用作已加载图片数据的内存缓存。键是页码（从 0 开始），值是对应的图片数据（NumPy 数组）。
    - `is_loaded` (bool): 一个布尔标志，指示漫画的所有图片是否已完全加载到 `loaded_images` 缓存中。
    - `is_zip` (bool): 一个布尔标志，指示漫画是否以 ZIP 压缩包的形式存储。
- **方法**:

#### 类: [`MangaLoader`](core/manga_model.py:165)
- **描述**: `MangaLoader` 类专门负责漫画图片的实际加载和预处理。它能够根据需要从 ZIP 文件或文件夹中加载单张图片，并提供预加载整个漫画所有图片的功能，以优化阅读体验。
- **信号 (Signals)**:
    - `preload_progress = Signal(int, str)`: 在图片预加载过程中，当进度更新时发射，携带已完成的百分比和当前操作的描述消息。
- **方法**:
### 文件: [`core/manga_text_replacer.py`](core/manga_text_replacer.py)

此文件定义了 [`MangaTextReplacer`](core/manga_text_replacer.py:12) 类，它负责在漫画图片上绘制翻译后的文本，并处理原始文本的擦除（inpaint）。

#### 类: [`MangaTextReplacer`](core/manga_text_replacer.py:12)
- **描述**: `MangaTextReplacer` 是一个单例类，其核心功能是将翻译后的文本精确地绘制到漫画图片上，并在此过程中处理原始文本的擦除（即图像修复或 inpaint）。它提供了高度可定制的文本绘制功能，包括字体选择、大小、颜色、描边效果、文本方向（水平或垂直）、对齐方式，以及复杂的背景修复算法，以确保翻译文本与漫画的原始艺术风格和谐融合。
- **方法**:
### 文件: [`core/ocr_cache_manager.py`](core/ocr_cache_manager.py)

此文件定义了 [`OcrCacheManager`](core/ocr_cache_manager.py:16) 类，它是一个用于缓存 OCR（光学字符识别）结果的管理器。

#### 类: [`OcrCacheManager`](core/ocr_cache_manager.py:16)
- **描述**: `OcrCacheManager` 继承自抽象基类 [`CacheInterface`](core/cache_interface.py:12)，专门负责管理 OCR（光学字符识别）过程的识别结果缓存。它使用 SQLite 数据库作为持久化存储，将图片文件的唯一标识（由路径、大小、修改时间戳和页码组合生成）作为缓存键，并存储序列化的 [`OCRResult`](core/data_models.py:10) 对象列表。这种缓存机制对于避免重复执行耗时且计算密集型的 OCR 操作至关重要，从而提高应用程序的响应速度和效率。
- **方法**:
### 文件: [`core/ocr_manager.py`](core/ocr_manager.py)

此文件定义了 [`OCRManager`](core/ocr_manager.py:12) 类，它是一个单例管理器，负责协调 OCR（光学字符识别）操作。

#### 类: [`OCRManager`](core/ocr_manager.py:12)
- **描述**: `OCRManager` 是一个单例类，其核心职责是管理和协调应用程序中的 OCR（光学字符识别）操作。它集成了 `ONNXPaddleOcr` 库来执行实际的文本识别，并高效地利用 [`OcrCacheManager`](core/ocr_cache_manager.py:16) 对 OCR 结果进行缓存，从而显著提高处理效率。该管理器支持对单张图片进行同步 OCR 识别，也支持对多张图片进行异步批量 OCR 任务，并提供了对 OCR 结果的过滤和结构化功能。
- **信号 (Signals)**:
    - `ocr_progress` (int, str): 在 OCR 任务执行过程中，当进度更新时发射，携带已完成的百分比和当前操作的描述消息。
    - `ocr_finished` (object): 当 OCR 任务完成时发射，携带 OCR 结果（通常是 [`OCRResult`](core/data_models.py:10) 对象的列表）。
    - `error_occurred` (str): 当 OCR 过程中发生任何错误时发射，携带错误描述信息。
- **方法**:
### 文件: [`core/translator_factory.py`](core/translator_factory.py)

此文件定义了 [`TranslatorFactory`](core/translator_factory.py:10) 类，它是一个单例工厂，负责根据配置创建不同类型的翻译器实例。

#### 类: [`TranslatorFactory`](core/translator_factory.py:10)
- **描述**: `TranslatorFactory` 是一个单例工厂类，其主要职责是根据应用程序的当前配置（特别是 [`config.translator_type`](core/config.py:38)）动态地创建和提供不同类型的翻译器实例。它支持多种翻译引擎，例如 Zhipu 和 Google，旨在为应用程序提供一个灵活且易于扩展的翻译服务接入点。通过使用工厂模式，它将翻译器对象的创建逻辑与客户端代码解耦。
- **方法**:
### 文件: [`core/translator_interface.py`](core/translator_interface.py)

此文件定义了 [`TranslatorInterface`](core/translator_interface.py:10) 抽象基类 (ABC)，它为所有翻译器实现了统一的接口。

#### 类: [`TranslatorInterface`](core/translator_interface.py:10)
- **描述**: `TranslatorInterface` 是一个抽象基类 (ABC)，它定义了所有具体翻译器类（如 `ZhipuTranslator`、`GoogleTranslator` 等）必须实现的标准接口。这种设计模式确保了不同翻译引擎之间的互操作性和可替换性，使得应用程序的上层逻辑可以不关心具体的翻译实现细节，从而提高了代码的模块化和可维护性。
- **方法**:
### 文件: [`core/google_translator.py`](core/google_translator.py)

此文件定义了 [`GoogleTranslator`](core/google_translator.py:10) 类，它是 [`TranslatorInterface`](core/translator_interface.py:10) 的一个具体实现，用于通过 Google 翻译服务进行文本翻译。

#### 类: [`GoogleTranslator`](core/google_translator.py:10)
- **描述**: `GoogleTranslator` 类是 [`TranslatorInterface`](core/translator_interface.py:10) 抽象基类的一个具体实现，它利用 `googletrans` 库（一个非官方的 Google Translate API 客户端）提供文本翻译功能。该翻译器旨在将文本从源语言（默认为英文）翻译成目标语言（默认为简体中文），并遵守 Google 翻译的速率限制。它提供了与 Google 翻译服务交互的封装，使得应用程序可以方便地进行文本翻译。
- **方法**:
### 文件: [`core/zhipu_translator.py`](core/zhipu_translator.py)

此文件定义了 [`ZhipuTranslator`](core/zhipu_translator.py:10) 类，它是 [`TranslatorInterface`](core/translator_interface.py:10) 的一个具体实现，用于通过智谱 AI (Zhipu AI) 服务进行文本翻译。

#### 类: [`ZhipuTranslator`](core/zhipu_translator.py:10)
- **描述**: `ZhipuTranslator` 类是 [`TranslatorInterface`](core/translator_interface.py:10) 抽象基类的一个具体实现，它通过调用智谱 AI (Zhipu AI) 的 API 提供文本翻译功能。该翻译器支持将文本从源语言翻译到目标语言，并考虑了智谱 AI 接口的特点和速率限制。它封装了与智谱 AI 平台交互的逻辑，使得应用程序能够便捷地集成智谱 AI 的翻译服务。
- **方法**:
### 文件: [`core/utils.py`](core/utils.py)

此文件包含了各种实用工具函数和类，用于支持漫画阅读器应用程序的多种功能，包括日志记录、文件路径处理、图像处理、文本转换、以及一些通用工具。

#### 类和函数:

**1. 日志记录相关**

- `set_logger_level(level: int)`:

**2. 文件和路径处理**


**3. 图像处理**


**4. 文本处理和转换**


**5. 其他通用工具**

### 文件: [`core/image_inpaint.py`](core/image_inpaint.py)

此文件定义了 [`ImageInpaint`](core/image_inpaint.py:10) 类，用于在图像中执行图像修复（inpaint）操作，主要用于移除或替换图像中的特定区域，如文本。

#### 类: [`ImageInpaint`](core/image_inpaint.py:10)
- **描述**: `ImageInpaint` 类是一个专门用于在图像中执行图像修复 (inpaint) 操作的工具类。其核心功能是智能地移除或替换图像中的特定区域，例如在漫画翻译过程中擦除原始文本或水印。它底层利用了 OpenCV 库提供的图像修复算法，以实现无缝的图像内容填充。
- **方法**:
### 文件: [`core/image_segmentation.py`](core/image_segmentation.py)

此文件定义了 [`ImageSegmentation`](core/image_segmentation.py:10) 类，用于图像分割任务，特别是用于识别和隔离图像中的文本区域。

#### 类: [`ImageSegmentation`](core/image_segmentation.py:10)
- **描述**: `ImageSegmentation` 类是一个专门用于图像分割任务的工具类。尽管其内部可能使用了 `PaddleSeg` 库中的 `PP-HumanSeg` 模型（通常用于人像分割），但在本应用场景中，它可能被更通用地用于识别和隔离图像中的特定区域，例如漫画中的文本框或人物。其主要目的是为后续的图像处理（如图像修复或文本替换）提供精确的区域掩码。
- **方法**:
### 文件: [`core/image_tools.py`](core/image_tools.py)

此文件定义了 [`ImageTools`](core/image_tools.py:10) 类，它提供了一系列静态方法，用于处理图像的各种操作，包括图像编码/解码、旋转、调整大小、转换为 NumPy 数组以及颜色空间转换。

#### 类: [`ImageTools`](core/image_tools.py:10)
- **描述**: `ImageTools` 类是一个实用工具类，旨在提供一系列方便的静态方法来执行各种常见的图像处理操作。这些操作涵盖了图像在不同数据格式（如字节数据和 OpenCV 的 NumPy 数组格式）之间的转换、图像的几何变换（如旋转和调整大小），以及颜色空间转换（如 BGR 到 RGB 或 RGB 到 BGR）。它将这些通用的图像处理逻辑封装起来，使得在应用程序的其他部分可以方便地调用。
- **方法**:
### 文件: [`core/image_viewer.py`](core/image_viewer.py)

此文件定义了 [`ImageViewer`](core/image_viewer.py:10) 类，这是一个基于 PySide6 的自定义 QWidget，用于显示图像，并支持缩放、拖动和旋转等交互功能。

#### 类: [`ImageViewer`](core/image_viewer.py:10)
- **描述**: `ImageViewer` 是一个自定义的 PySide6 [`QWidget`](https://doc.qt.io/qtforpython-6/PySide6/QtWidgets/QWidget.html#PySide6.QtWidgets.QWidget)，专门用于高效地显示图像，并提供丰富的用户交互功能。它支持通过鼠标滚轮进行图像缩放、通过鼠标拖动进行图像平移（拖动），以及通过键盘事件进行图像旋转。这个组件旨在为用户提供一个灵活且响应迅速的图像查看体验，特别适用于需要频繁查看和操作图像的应用程序，如漫画阅读器。
- **信号 (Signals)**:
    - `zoom_changed = Signal(float)`: 当图像的缩放级别发生变化时发射此信号，并传递当前的缩放因子作为参数。
    - `image_loaded = Signal()`: 当新的图像数据成功加载并准备好显示时发射此信号。
- **方法**:
### 文件: [`core/reader_manager.py`](core/reader_manager.py)

此文件定义了 [`ReaderManager`](core/reader_manager.py:10) 类，它是一个单例管理器，负责处理漫画阅读的核心逻辑，包括页面加载、导航、图像预加载和缓存管理。

#### 类: [`ReaderManager`](core/reader_manager.py:10)
- **描述**: `ReaderManager` 是一个单例类，其核心职责是管理漫画阅读的所有关键逻辑。它负责处理漫画页面的高效加载、用户在页面间的导航、图像的预加载以确保流畅的阅读体验，以及对已加载页面的缓存管理。该管理器与 [`MangaManager`](core/manga_manager.py:18) 紧密协作以获取漫画信息和图像数据，并利用多线程技术进行图像的异步加载，从而避免阻塞用户界面。
- **信号 (Signals)**:
    - `page_loaded = Signal(int, object)`: 当单个漫画页面加载完成时发射此信号。它携带两个参数：加载完成的页码 (`int`) 和加载的图像数据 (`object`，通常是 NumPy 数组)。
    - `loading_progress = Signal(int)`: 在漫画加载或预加载过程中，当进度更新时发射此信号，携带一个整数表示完成的百分比。
    - `error_occurred = Signal(str)`: 当在漫画加载或阅读过程中发生任何错误时发射此信号，携带一个字符串参数，描述发生的错误信息。
- **方法**:
### 文件: [`core/language_detector.py`](core/language_detector.py)

此文件定义了 [`LanguageDetector`](core/language_detector.py:10) 类，它是一个单例管理器，用于检测给定文本的语言。

#### 类: [`LanguageDetector`](core/language_detector.py:10)
- **描述**: `LanguageDetector` 是一个单例类，其核心功能是识别给定文本的自然语言。它集成了 `langid` 库，这是一个轻量级且高效的语言识别工具，能够准确识别多种语言，并返回识别出的语言代码和相应的置信度。这个类在漫画阅读器应用中非常有用，例如在进行文本翻译前自动检测原始文本的语言。
- **方法**:
### 文件: [`core/ocr_engine.py`](core/ocr_engine.py)

此文件定义了 [`ONNXPaddleOcr`](core/ocr_engine.py:10) 类，它是一个封装了 PaddleOCR 模型的 OCR 引擎，用于进行文本检测和识别。

#### 类: [`ONNXPaddleOcr`](core/ocr_engine.py:10)
- **描述**: `ONNXPaddleOcr` 类是一个核心组件，它封装了基于 ONNX Runtime 的 PaddleOCR 模型，专门用于在图像中执行高效的文本检测和识别。该类提供了灵活的配置选项，允许用户指定不同的模型路径（检测模型、识别模型、分类模型）以及是否利用 GPU 进行加速推理，并可选择特定的 GPU ID。它是应用程序中执行光学字符识别 (OCR) 任务的主要引擎。
- **方法**:
### 文件: [`core/translator_pool.py`](core/translator_pool.py)

此文件定义了 [`TranslatorPool`](core/translator_pool.py:10) 类，它是一个用于管理和调度翻译器实例的池，以优化并发翻译任务。

#### 类: [`TranslatorPool`](core/translator_pool.py:10)
- **描述**: `TranslatorPool` 类是一个单例翻译器实例池管理器，其主要目标是优化应用程序中并发翻译任务的执行。它通过维护一个可复用的翻译器实例队列，并结合线程池来异步处理翻译请求。这种设计模式有效地管理了翻译资源的分配和释放，有助于控制对外部翻译服务的调用频率（QPS/TPM），从而避免超出 API 限制并提高整体翻译效率。
- **信号 (Signals)**:
    - `translation_finished = Signal(str, str, object)`: 当一个翻译任务成功完成时发射此信号。它携带三个参数：原始文本 (`str`)、翻译后的文本结果 (`str`) 和用户在提交任务时提供的任意用户数据 (`object`)。
    - `error_occurred = Signal(str)`: 当在翻译池中发生任何错误时发射此信号，携带一个字符串参数，描述发生的错误信息。
- **方法**:
### 文件: [`core/translator_pool_worker.py`](core/translator_pool_worker.py)

此文件定义了 [`TranslatorPoolWorker`](core/translator_pool_worker.py:10) 类，它是一个 QRunnable，用于在 [`TranslatorPool`](core/translator_pool.py:10) 中执行单个翻译任务。

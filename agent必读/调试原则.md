# Agent 调试原则

## 🔍 **核心原则：先测试，后修复**

### **重要提醒**
> **以后为了检查问题在哪里，你可以每一步都写一个简单的测试文件检验一下，测完记得删掉。**

### **调试流程**

#### **1. 问题发现阶段**
- ❌ **不要盲猜**：不要基于假设来修复问题
- ✅ **先观察**：通过测试文件输出实际的数据结构
- ✅ **记录现象**：详细记录错误信息和异常行为

#### **2. 数据结构验证**
- 📝 **创建测试文件**：写简单的Python脚本验证数据结构
- 🔍 **输出详细信息**：
  - 数据类型：`type(data)`
  - 数据内容：`print(data)`
  - 字段列表：`list(data.keys())` (如果是字典)
  - 字段类型：逐个检查每个字段的类型

#### **3. API调用测试**
- 🌐 **直接调用API**：使用curl或Python requests测试
- 📊 **检查响应**：验证API返回的数据格式
- 🔗 **追踪数据流**：从数据源到API响应的完整路径

#### **4. 逐步验证修复**
- 🧪 **小步测试**：每修改一个地方就测试一次
- ✅ **验证假设**：确认修复方向是正确的
- 🔄 **迭代改进**：基于测试结果调整修复策略

#### **5. 清理工作**
- 🗑️ **删除测试文件**：修复完成后删除临时测试文件
- 📝 **记录经验**：将调试过程中的发现记录下来

### **测试文件模板**

#### **数据结构测试模板**
```python
#!/usr/bin/env python3
"""
临时测试文件 - 验证数据结构
用完即删
"""

def test_data_structure():
    # 导入相关模块
    from core.xxx import xxx
    
    # 获取数据
    data = get_some_data()
    
    # 详细输出
    print("=" * 50)
    print("数据结构测试")
    print("=" * 50)
    print(f"数据类型: {type(data)}")
    print(f"数据内容: {data}")
    
    if isinstance(data, dict):
        print(f"字段列表: {list(data.keys())}")
        for key, value in data.items():
            print(f"  {key}: {type(value)} = {value}")
    
    elif isinstance(data, list) and data:
        print(f"列表长度: {len(data)}")
        print(f"第一个元素类型: {type(data[0])}")
        print(f"第一个元素内容: {data[0]}")

if __name__ == "__main__":
    test_data_structure()
```

#### **API测试模板**
```python
#!/usr/bin/env python3
"""
临时测试文件 - 验证API调用
用完即删
"""

import requests
import json

def test_api():
    url = "http://localhost:8000/api/xxx"
    
    try:
        response = requests.get(url)
        print("=" * 50)
        print("API测试结果")
        print("=" * 50)
        print(f"状态码: {response.status_code}")
        print(f"响应头: {dict(response.headers)}")
        
        if response.status_code == 200:
            data = response.json()
            print(f"响应数据类型: {type(data)}")
            print(f"响应数据: {json.dumps(data, indent=2, ensure_ascii=False)}")
        else:
            print(f"错误响应: {response.text}")
            
    except Exception as e:
        print(f"请求失败: {e}")

if __name__ == "__main__":
    test_api()
```

### **实际案例：缓存管理调试**

在缓存管理功能开发中，遇到Pydantic验证错误：
```
created_time: Input should be a valid string [type=string_type, input_value=1748705486.752638, input_type=float]
```

**错误的做法**：
- ❌ 盲猜是时间格式问题
- ❌ 直接修改API代码
- ❌ 假设所有缓存都有相同的字段名

**正确的做法**：
1. ✅ 创建`test_cache_data.py`测试文件
2. ✅ 输出所有缓存类型的实际数据结构
3. ✅ 发现不同缓存使用不同的时间字段名：
   - OCR缓存：`last_modified` (float)
   - 漫画列表缓存：`last_updated` (string)
   - 翻译缓存：`last_updated` (string)
4. ✅ 针对性修复每种缓存的字段处理
5. ✅ 删除测试文件

### **经验总结**

- 🎯 **精确定位**：测试文件帮助精确定位问题根源
- 🚀 **提高效率**：避免反复猜测和试错
- 🛡️ **降低风险**：减少因盲目修改导致的新问题
- 📚 **积累经验**：每次调试都是学习机会

### **注意事项**

- ⚠️ **及时清理**：测试文件用完立即删除
- 📁 **统一命名**：使用`test_xxx.py`格式命名
- 🔒 **避免提交**：不要将测试文件提交到版本控制
- 📝 **记录发现**：将重要发现记录到文档中

## 🌐 **Web UI 开发重要原则**

### **Vue.js 模板语法统一规则**

**⚠️ 极其重要：避免 Jinja2 与 Vue.js 语法冲突**

在 Web UI 的 HTML 模板中，**绝对禁止使用** Vue.js 的双花括号语法 `{{ }}`，因为会与 Jinja2 模板引擎冲突导致服务器报错。

**错误示例（会导致服务器崩溃）：**
```html
<!-- ❌ 绝对不要这样写 -->
<span>{{ translationProgress.completed }}</span>
<div>{{ task.fileName }}</div>
<p>{{ task.currentPage }} / {{ task.totalPages }}</p>
```

**正确示例：**
```html
<!-- ✅ 正确 - 使用 v-text 指令 -->
<span v-text="translationProgress.completed"></span>
<div v-text="task.fileName"></div>
<p><span v-text="task.currentPage"></span> / <span v-text="task.totalPages"></span></p>

<!-- ✅ 正确 - 属性绑定 -->
<div :title="task.fileName" :class="{ active: task.status === 'completed' }">

<!-- ✅ 正确 - 条件和循环 -->
<div v-if="isTranslating" v-for="task in translationTasks" :key="task.id">
```

**统一规则（必须严格遵守）：**
1. **文本显示**：使用 `v-text="expression"`
2. **HTML内容**：使用 `v-html="expression"`
3. **属性绑定**：使用 `:attribute="expression"`
4. **条件渲染**：使用 `v-if`、`v-show`、`v-else`
5. **列表渲染**：使用 `v-for`
6. **事件处理**：使用 `@event="handler"`
7. **双向绑定**：使用 `v-model="data"`

**这个原则在之前的开发中已经确立并实施，任何违反都会导致系统崩溃！**

### **常见错误和修复**

**错误类型：** `jinja2.exceptions.UndefinedError: 'variableName' is undefined`

**原因：** 在HTML模板中使用了 `{{ variableName }}` 语法

**修复方法：** 将所有 `{{ expression }}` 替换为 `v-text="expression"`

**检查清单：**
- [ ] 搜索模板中的所有 `{{` 和 `}}`
- [ ] 确认没有遗漏的双花括号语法
- [ ] 测试页面加载是否正常
- [ ] 验证动态内容显示是否正确

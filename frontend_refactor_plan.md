# 漫画查看器前端重构计划

## 1. 背景与动机

当前漫画查看器（`viewer.html`）功能完善，但在代码组织上采用了传统的“单文件”模式。所有的HTML结构、CSS样式和JavaScript逻辑高度集中在一个文件中。

经过分析，我们识别出以下几个核心问题：

- **可维护性差：** `viewer.html` 文件过大，尤其是其内联的 `<script>` 标签包含了近700行业务逻辑，导致后续修改、排查问题变得困难和低效。
- **代码重复：** Vue的 `setup` 函数中存在逻辑重复，增加了代码的冗余度和潜在的出错点。
- **用户体验瑕疵：** 应用在初次加载时，会出现一个短暂的、与深色主题不协调的白色“加载中”提示，影响了视觉上的整体感和流畅性。

本次重构的**核心动机**是在**不引入任何额外构建工具或复杂工作流**的前提下，通过优化代码结构和解决现有问题，提升项目的代码质量、可维护性和用户体验。

## 2. 重构核心原则

- **零构建 (Zero-Build):** **不**引入Vite、Webpack等任何需要“编译/打包”步骤的工具。所有重构后的代码必须能直接在现代浏览器中运行。
- **保持简洁 (Maintain Simplicity):** 维持项目“直接编辑、刷新查看”的核心工作流程。最终的文件结构和开发体验必须保持简单、直观。
- **关注体验 (Focus on UX):** 优先解决具体的用户体验问题，为用户（即开发者本人）提供一个更稳定、更无缝的应用。

## 3. 具体实施方案

### 任务一：JavaScript 逻辑模块化拆分

- **现状：** 业务逻辑全部内联在 `viewer.html` 的 `<script>` 标签中。
- **方案：**
    1.  在 `web/static/js/` 目录下创建新的JavaScript文件，用于承载不同的功能模块。建议结构如下：
        - `viewer/state.js`: 负责定义和导出所有共享的响应式状态（如 `mangaInfo`, `currentPage`）。
        - `viewer/controls.js`: 负责处理所有用户交互逻辑（如按钮点击、滑块拖动、键盘事件等）。
        - `viewer/core.js`: 作为主入口，负责初始化Vue实例，整合状态和控制逻辑，并挂载应用。
    2.  在 `viewer.html` 的末尾，移除原有的内联脚本，并使用 `<script type="module">` 来加载 `viewer/core.js`。
- **预期收益：**
    - `viewer.html` 变得干净，只承载HTML结构。
    - JavaScript代码实现高内聚、低耦合，每个文件的职责单一，易于理解和修改。
    - 从根本上消除代码重复问题。

### 任务二：解决初始加载闪烁问题

- **现状：** `v-if="isLoading"` 的逻辑导致一个白色的`div`元素在数据加载时短暂显示，与深色主题冲突。
- **方案：**
    1.  移除 `v-if="isLoading"` 指令以及相关的 `loading-container` 元素。
    2.  确保图片显示区域（`.image-container`）始终存在于DOM中。
    3.  为其设置一个与应用背景色一致的默认背景，或一个简单的深色占位符。这样，即使用户的网络状况极差，看到的也是一个和谐的占位背景，而不是刺眼的白屏。
- **预期收益：**
    - 提升应用的“感知性能”，启动过程视觉上更平滑、无缝。
    - 增强UI的一致性和专业感。

### 任务三：CSS 样式优化

- **现状：** `viewer.css` 中存在对 `!important` 的过度依赖，可能导致样式覆盖困难和不可预测的渲染问题。
- **方案：**
    1.  系统性地审查 `viewer.css` 文件。
    2.  通过编写更具体、更高优先级的CSS选择器来替代 `!important`。例如，用 `#app .left-sidebar .nav-btn` 替代 `.nav-btn`。
- **预期收益：**
    - CSS代码更健壮、可预测，未来的样式调整会更简单、更安全。

## 4. 注意事项与潜在风险

- **浏览器兼容性：** 本方案依赖浏览器原生的ES Modules (`<script type="module">`) 支持。这要求使用现代浏览器（如Chrome 61+, Firefox 60+, Safari 10.1+）。考虑到这是个人本地项目，此风险基本可忽略。
- **模块间通信：** 在JS文件拆分后，需要建立清晰的数据流。
    - **推荐模式：** 由 `state.js` 统一导出所有共享状态，由 `controls.js` 导出所有方法。`core.js` 负责导入这两者并注入到Vue实例中。应避免模块间的循环依赖。
- **调试方式变化：** 之前只需要在浏览器的开发者工具中查看一个内联脚本，现在则需要根据功能在“源代码”面板中查找对应的JS文件进行断点调试。这需要短暂的适应。
- **避免全局污染：** 拆分后的JS模块应严格使用 `import`/`export` 语法，避免将变量或函数意外地暴露到全局 `window` 对象上。

## 5. 总结

本计划在完全尊重项目维护者对**简洁性**的核心要求基础上，提供了一套切实可行的优化路径。它通过模块化、解决具体UI问题和优化代码风格，能够在不增加任何工程复杂度的情况下，显著提升项目的健康度和未来可维护性。
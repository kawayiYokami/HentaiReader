<!DOCTYPE html>
<html lang="zh-CN" class="theme-dark" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>漫画查看器</title>
    
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="/static/css/modern-theme.css">
    <link rel="stylesheet" href="/static/css/viewer.css">
</head>
<body>
    <div id="app">
        <!-- 左侧控制栏 -->
        <div class="left-sidebar">

            <!-- 漫画标题 -->
            <div class="manga-title-section">
                <div class="manga-title-vertical">{{ mangaInfo.title || '加载中...' }}</div>
            </div>

            <!-- 显示模式切换 -->
            <div class="display-mode-section">
                <el-button
                    @click="toggleDisplayMode"
                    type="primary"
                    text
                    class="mode-btn">
                    {{ actualDisplayMode === 'single' ? '单页' : '双页' }}
                </el-button>
            </div>

            <!-- 翻译开关 -->
            <div class="translation-section">
                <el-button
                    @click="toggleTranslation"
                    type="primary"
                    text
                    :class="['translation-btn', { 'translation-active': translationEnabled }]">
                    译
                </el-button>
            </div>

            <!-- 页面导航 -->
            <div class="page-navigation">
                <el-button
                    @click="previousPage"
                    :disabled="currentPage <= 0"
                    type="primary"
                    class="nav-btn">
                    ↑
                </el-button>

                <div class="page-info-section">
                    <!-- 页码显示和输入 -->
                    <div class="page-display" @click="showPageInput = true" v-if="!showPageInput">
                        <div class="current-page">{{ currentPage + 1 }}</div>
                        <div class="page-divider">/</div>
                        <div class="total-pages">{{ mangaInfo.total_pages || 0 }}</div>
                    </div>

                    <!-- 页码输入框（点击时显示） -->
                    <div class="page-input-wrapper" v-if="showPageInput">
                        <el-input
                            v-model="pageInputText"
                            size="small"
                            @blur="onPageInputBlur"
                            @keyup.enter="onPageInputEnter"
                            @keyup.escape="cancelPageInput"
                            ref="pageInputRef"
                            class="page-input">
                        </el-input>
                        <div class="page-divider">/</div>
                        <div class="total-pages">{{ mangaInfo.total_pages || 0 }}</div>
                    </div>

                    <!-- 圆形进度条 -->
                    <div class="progress-circle">
                        <svg width="60" height="60" class="progress-svg">
                            <circle cx="30" cy="30" r="25" class="progress-bg"></circle>
                            <circle cx="30" cy="30" r="25" class="progress-fill"
                                    :stroke-dasharray="progressCircumference"
                                    :stroke-dashoffset="progressOffset"></circle>
                        </svg>
                        <div class="progress-text">{{ Math.round(progressPercentage) }}%</div>
                    </div>
                </div>

                <el-button
                    @click="nextPage"
                    :disabled="currentPage >= (mangaInfo.total_pages || 1) - 1"
                    type="primary"
                    class="nav-btn">
                    ↓
                </el-button>
            </div>

            <!-- 全屏按钮 -->
            <div class="fullscreen-section">
                <el-button @click="toggleFullscreen" type="primary" text class="nav-btn">
                    {{ isFullscreen ? '⊡' : '⊞' }}
                </el-button>
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="viewer-content" ref="viewerContent">
            <!-- 加载状态 -->
            <div v-if="isLoading" class="loading-container">
                <el-loading-directive v-loading="true" text="加载中..."></el-loading-directive>
            </div>

            <!-- 图片显示区域 -->
            <div v-else-if="currentImageUrls.length > 0" class="image-container" @click="onImageClick">
                <!-- 单页模式 -->
                <img
                    v-if="actualDisplayMode === 'single'"
                    :src="currentImageUrls[0]"
                    :alt="`第 ${currentPage + 1} 页`"
                    class="manga-image single-page"
                    @load="onImageLoad"
                    @error="onImageError"
                    ref="mangaImage">

                <!-- 双页模式 -->
                <div v-else-if="actualDisplayMode === 'double'" class="double-page-container">
                    <img
                        v-for="(imageUrl, index) in currentImageUrls"
                        :key="currentPage + index"
                        :src="imageUrl"
                        :alt="`第 ${currentPage + index + 1} 页`"
                        class="manga-image double-page"
                        @load="onImageLoad"
                        @error="onImageError">
                </div>
            </div>

            <!-- 错误状态 -->
            <div v-else class="error-container">
                <el-empty description="无法加载图片">
                    <el-button @click="loadCurrentPage" type="primary">重试</el-button>
                </el-empty>
            </div>
        </div>


    </div>

    <!-- Vue 3 和 Element Plus -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        const { createApp, ref, reactive, computed, watch, onMounted, onUnmounted, nextTick } = Vue;
        const { ElMessage, ElLoading } = ElementPlus;

        createApp({
            setup() {
                // 响应式数据
                const mangaInfo = reactive({
                    file_path: '',
                    title: '',
                    total_pages: 0
                });

                const currentPage = ref(0);
                const showPageInput = ref(false); // 是否显示页码输入框
                const pageInputText = ref('1'); // 页码输入框的文本值
                const currentImageUrls = ref([]);
                const nextImageUrls = ref([]); // 预加载的下一组图片
                const isLoading = ref(false);
                const isFullscreen = ref(false);
                const displayMode = ref('auto'); // 'auto', 'single', 'double'
                const translationEnabled = ref(false); // 翻译开关状态
                const screenInfo = reactive({
                    width: window.innerWidth,
                    height: window.innerHeight,
                    ratio: window.innerWidth / window.innerHeight
                });

                // DOM引用
                const viewerContent = ref(null);
                const mangaImage = ref(null);
                const pageInputRef = ref(null);

                // 获取URL参数
                const urlParams = new URLSearchParams(window.location.search);
                const mangaPath = urlParams.get('path');
                const initialPage = parseInt(urlParams.get('page') || '0');
                const themeParam = urlParams.get('theme');
                const isIframe = urlParams.get('iframe') === 'true';


                // 计算属性
                const actualDisplayMode = computed(() => {
                    if (displayMode.value === 'single') return 'single';
                    if (displayMode.value === 'double') return 'double';

                    // 自动模式：根据屏幕比例决定
                    // 宽屏显示器 (比例 > 1.5) 且屏幕宽度 > 1200px 时使用双页
                    return (screenInfo.ratio > 1.5 && screenInfo.width > 1200) ? 'double' : 'single';
                });

                const progressPercentage = computed(() => {
                    if (mangaInfo.total_pages === 0) return 0;
                    return ((currentPage.value + 1) / mangaInfo.total_pages) * 100;
                });

                const pagesToLoad = computed(() => {
                    return actualDisplayMode.value === 'double' ? 2 : 1;
                });

                // 圆形进度条计算
                const progressCircumference = computed(() => {
                    return 2 * Math.PI * 25; // 半径25的圆周长
                });

                const progressOffset = computed(() => {
                    const circumference = progressCircumference.value;
                    return circumference - (progressPercentage.value / 100) * circumference;
                });

                // ==================== 初始化 ====================

                // 简化的主题消息监听器
                // Removed theme message listener (initThemeMessageListener) and applyCSSVars function.
                // This viewer is intentionally set to always use a dark theme (via <html class="theme-dark">)
                // and does not sync with or inherit theme from the parent page.

                // 应用CSS变量
                onMounted(async () => {
                    // 初始化主题消息监听器



                    if (!mangaPath) {
                        ElMessage.error('缺少漫画路径参数');
                        return;
                    }

                    // 检测是否在桌面应用中，添加相应的CSS类
                    if (isDesktopApp()) {
                        document.body.classList.add('desktop-app');
                        console.log('检测到桌面应用环境，应用桌面优化样式');
                    }

                    await loadMangaInfo();
                    currentPage.value = Math.max(0, Math.min(initialPage, mangaInfo.total_pages - 1));
                    pageInputText.value = (currentPage.value + 1).toString(); // 初始化输入框
                    await loadCurrentPage();

                    // 添加事件监听
                    document.addEventListener('keydown', handleKeydown);
                    document.addEventListener('fullscreenchange', handleFullscreenChange);
                    document.addEventListener('wheel', handleWheel, { passive: false });
                    window.addEventListener('resize', handleResize);
                });

                // 检测是否在桌面应用中运行
                function isDesktopApp() {
                    return window.navigator.userAgent.includes('pywebview') ||
                           window.location.protocol === 'file:' ||
                           (!window.opener && !window.parent && window.location.hostname === '127.0.0.1');
                }

                onUnmounted(() => {
                    document.removeEventListener('keydown', handleKeydown);
                    document.removeEventListener('fullscreenchange', handleFullscreenChange);
                    document.removeEventListener('wheel', handleWheel);
                    window.removeEventListener('resize', handleResize);
                });

                function handleResize() {
                    screenInfo.width = window.innerWidth;
                    screenInfo.height = window.innerHeight;
                    screenInfo.ratio = window.innerWidth / window.innerHeight;

                    // 如果是自动模式，重新加载页面以适应新的显示模式
                    if (displayMode.value === 'auto') {
                        nextTick(() => {
                            loadCurrentPage();
                        });
                    }
                }

                function handleWheel(event) {
                    event.preventDefault();

                    // 向下滚动 = 下一页，向上滚动 = 上一页
                    if (event.deltaY > 0) {
                        nextPage();
                    } else if (event.deltaY < 0) {
                        previousPage();
                    }
                }

                // ==================== 数据加载 ====================

                async function loadMangaInfo() {
                    try {
                        isLoading.value = true;
                        const response = await axios.post('/api/manga/viewer/info', {
                            manga_path: mangaPath
                        });

                        Object.assign(mangaInfo, response.data);
                        console.log('漫画信息加载成功:', mangaInfo);

                    } catch (error) {
                        console.error('加载漫画信息失败:', error);
                        ElMessage.error('加载漫画信息失败');
                    } finally {
                        isLoading.value = false;
                    }
                }

                // 图片预加载缓存
                const imageCache = new Map();

                async function loadPageImages(startPage, count) {
                    const imageUrls = [];

                    for (let i = 0; i < count; i++) {
                        const pageNum = startPage + i;

                        // 检查页码是否有效
                        if (pageNum >= mangaInfo.total_pages || pageNum < 0) break;

                        // 检查缓存
                        const cacheKey = `${mangaPath}_${pageNum}`;
                        if (imageCache.has(cacheKey)) {
                            imageUrls.push(imageCache.get(cacheKey));
                            console.log(`页面 ${pageNum + 1} 从缓存加载`);
                            continue;
                        }

                        try {
                            const response = await axios.post('/api/manga/viewer/page', {
                                manga_path: mangaPath,
                                page_num: pageNum
                            });

                            if (response.data && response.data.image) {
                                const imageUrl = response.data.image;
                                imageUrls.push(imageUrl);
                                imageCache.set(cacheKey, imageUrl);
                                console.log(`页面 ${pageNum + 1} 加载成功`);
                            } else {
                                console.warn(`页面 ${pageNum + 1} 数据无效`);
                                break;
                            }
                        } catch (error) {
                            console.error(`加载页面 ${pageNum + 1} 失败:`, error);
                            break;
                        }
                    }

                    return imageUrls;
                }

                async function loadCurrentPage() {
                    try {
                        const mode = actualDisplayMode.value;
                        const pagesToLoad = mode === 'double' ? 2 : 1;

                        // 加载当前页面
                        const imageUrls = await loadPageImages(currentPage.value, pagesToLoad);

                        if (imageUrls.length > 0) {
                            // 只有在新图片加载完成后才更新显示
                            currentImageUrls.value = imageUrls;
                            console.log(`${mode}模式加载完成，共 ${imageUrls.length} 页`);

                            // 预加载下一组页面（后台进行，不阻塞当前显示）
                            preloadNextPages();
                        } else {
                            throw new Error('无法加载任何图片');
                        }

                    } catch (error) {
                        console.error('加载页面失败:', error);
                        ElMessage.error(`加载第 ${currentPage.value + 1} 页失败`);
                        // 发生错误时不清空当前图片，保持显示
                    }
                }

                async function preloadNextPages() {
                    try {
                        const mode = actualDisplayMode.value;
                        const step = mode === 'double' ? 2 : 1;
                        const nextPageStart = currentPage.value + step;

                        // 预加载下一组页面
                        if (nextPageStart < mangaInfo.total_pages) {
                            await loadPageImages(nextPageStart, step);
                        }

                        // 预加载上一组页面
                        const prevPageStart = currentPage.value - step;
                        if (prevPageStart >= 0) {
                            await loadPageImages(prevPageStart, step);
                        }
                    } catch (error) {
                        // 预加载失败不影响当前显示
                        console.log('预加载失败:', error);
                    }
                }

                // ==================== 页面控制 ====================

                function previousPage() {
                    const step = actualDisplayMode.value === 'double' ? 2 : 1;
                    if (currentPage.value > 0) {
                        currentPage.value = Math.max(0, currentPage.value - step);
                        pageInputText.value = (currentPage.value + 1).toString(); // 同步更新输入框
                        loadCurrentPage();
                    }
                }

                function nextPage() {
                    const step = actualDisplayMode.value === 'double' ? 2 : 1;
                    if (currentPage.value < mangaInfo.total_pages - 1) {
                        currentPage.value = Math.min(mangaInfo.total_pages - 1, currentPage.value + step);
                        pageInputText.value = (currentPage.value + 1).toString(); // 同步更新输入框
                        loadCurrentPage();
                    }
                }

                function onPageChange(newPage) {
                    currentPage.value = newPage;
                    pageInputText.value = (newPage + 1).toString(); // 同步更新输入框文本
                    loadCurrentPage();
                }

                // 页码输入相关方法
                function onPageInputEnter() {
                    applyPageInput();
                }

                function onPageInputBlur() {
                    applyPageInput();
                }

                function cancelPageInput() {
                    showPageInput.value = false;
                    pageInputText.value = (currentPage.value + 1).toString(); // 恢复原值
                }

                function applyPageInput() {
                    const newPage = parseInt(pageInputText.value);
                    if (newPage && newPage >= 1 && newPage <= mangaInfo.total_pages) {
                        currentPage.value = newPage - 1; // 转换为0-based
                        loadCurrentPage();
                    } else {
                        // 输入无效，恢复原值
                        pageInputText.value = (currentPage.value + 1).toString();
                    }
                    showPageInput.value = false;
                }

                // 监听页码输入框显示状态，自动聚焦
                watch(showPageInput, (newValue) => {
                    if (newValue) {
                        nextTick(() => {
                            if (pageInputRef.value) {
                                pageInputRef.value.focus();
                                pageInputRef.value.select(); // 选中所有文本
                            }
                        });
                    }
                });

                function toggleDisplayMode() {
                    if (displayMode.value === 'auto') {
                        displayMode.value = 'single';
                    } else if (displayMode.value === 'single') {
                        displayMode.value = 'double';
                    } else {
                        displayMode.value = 'auto';
                    }
                    loadCurrentPage();
                }

                function toggleTranslation() {
                    translationEnabled.value = !translationEnabled.value;

                    if (translationEnabled.value) {
                        ElMessage.warning('翻译功能未实装，敬请期待！');
                        // 暂时关闭，等待后续实现
                        setTimeout(() => {
                            translationEnabled.value = false;
                        }, 1500);
                    } else {
                        console.log('翻译功能已关闭');
                    }
                }

                // ==================== 事件处理 ====================

                function handleKeydown(event) {
                    switch (event.key) {
                        case 'ArrowLeft':
                            event.preventDefault();
                            previousPage();
                            break;
                        case 'ArrowRight':
                            event.preventDefault();
                            nextPage();
                            break;
                        case 'Escape':
                            if (isFullscreen.value) {
                                exitFullscreen();
                            }
                            break;
                        case 'F11':
                            event.preventDefault();
                            toggleFullscreen();
                            break;
                    }
                }

                function onImageClick(event) {
                    // 点击图片左半部分上一页，右半部分下一页
                    const rect = event.currentTarget.getBoundingClientRect();
                    const clickX = event.clientX - rect.left;
                    const centerX = rect.width / 2;

                    if (clickX < centerX) {
                        previousPage();
                    } else {
                        nextPage();
                    }
                }

                function onImageLoad() {
                    console.log('图片加载完成');
                }

                function onImageError() {
                    console.error('图片加载失败');
                    ElMessage.error('图片加载失败');
                }

                // ==================== 全屏控制 ====================

                function toggleFullscreen() {
                    if (isFullscreen.value) {
                        exitFullscreen();
                    } else {
                        enterFullscreen();
                    }
                }

                function enterFullscreen() {
                    const element = viewerContent.value;
                    if (element.requestFullscreen) {
                        element.requestFullscreen();
                    } else if (element.webkitRequestFullscreen) {
                        element.webkitRequestFullscreen();
                    } else if (element.msRequestFullscreen) {
                        element.msRequestFullscreen();
                    }
                }

                function exitFullscreen() {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                }

                function handleFullscreenChange() {
                    isFullscreen.value = !!document.fullscreenElement;
                }

                // ==================== 导航 ====================
                // iframe方案不需要返回按钮，由父页面控制关闭

                return {
                    // 数据
                    mangaInfo,
                    currentPage,
                    showPageInput,
                    pageInputText,
                    currentImageUrls,
                    isLoading,
                    isFullscreen,
                    displayMode,
                    actualDisplayMode,
                    translationEnabled,
                    progressPercentage,
                    progressCircumference,
                    progressOffset,
                    screenInfo,

                    // DOM引用
                    viewerContent,
                    mangaImage,
                    pageInputRef,

                    // 方法
                    loadCurrentPage,
                    previousPage,
                    nextPage,
                    onPageChange,
                    onPageInputEnter,
                    onPageInputBlur,
                    cancelPageInput,
                    applyPageInput,
                    toggleDisplayMode,
                    toggleTranslation,
                    onImageClick,
                    onImageLoad,
                    onImageError,
                    toggleFullscreen
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>

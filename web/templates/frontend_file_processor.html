<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯æ–‡ä»¶å¤„ç†å™¨ - æ¼«ç”»å‹ç¼©å·¥å…·</title>
    
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .processor-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .upload-area {
            border: 2px dashed #dcdfe6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #409eff;
            background: #f0f9ff;
        }
        
        .upload-area.dragover {
            border-color: #67c23a;
            background: #f0f9ff;
        }
        
        .file-list {
            margin-top: 20px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid #ebeef5;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 500;
            color: #303133;
        }
        
        .file-size {
            font-size: 12px;
            color: #909399;
        }
        
        .progress-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .settings-panel {
            margin-top: 20px;
            padding: 20px;
            border-top: 1px solid #ebeef5;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- æ ‡é¢˜ -->
            <div class="header">
                <h1>ğŸ—œï¸ å‰ç«¯æ¼«ç”»å‹ç¼©å·¥å…·</h1>
                <p>å®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæ— éœ€ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨</p>
            </div>
            
            <!-- ä¸»å¤„ç†å¡ç‰‡ -->
            <div class="processor-card">
                <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-area" 
                     @click="triggerFileSelect"
                     @dragover.prevent="handleDragOver"
                     @dragleave.prevent="handleDragLeave"
                     @drop.prevent="handleDrop"
                     :class="{ dragover: isDragOver }">
                    
                    <el-icon size="48" color="#c0c4cc">
                        <upload-filled />
                    </el-icon>
                    
                    <h3>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</h3>
                    <p>æ”¯æŒ ZIPã€CBZã€CBR æ ¼å¼çš„æ¼«ç”»æ–‡ä»¶</p>
                    
                    <input ref="fileInput" 
                           type="file" 
                           multiple 
                           accept=".zip,.cbz,.cbr"
                           @change="handleFileSelect"
                           class="hidden">
                </div>
                
                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                <div v-if="selectedFiles.length > 0" class="file-list">
                    <h4>å·²é€‰æ‹©çš„æ–‡ä»¶ (<span v-text="selectedFiles.length"></span>)</h4>
                    
                    <div v-for="(file, index) in selectedFiles" 
                         :key="index" 
                         class="file-item">
                        <div class="file-info">
                            <div class="file-name" v-text="file.name"></div>
                            <div class="file-size" v-text="formatFileSize(file.size)"></div>
                        </div>
                        
                        <el-button type="danger" 
                                   size="small" 
                                   @click="removeFile(index)">
                            ç§»é™¤
                        </el-button>
                    </div>
                </div>
                
                <!-- å‹ç¼©è®¾ç½® -->
                <div v-if="selectedFiles.length > 0" class="settings-panel">
                    <h4>å‹ç¼©è®¾ç½®</h4>
                    
                    <el-row :gutter="20">
                        <el-col :span="12">
                            <el-form-item label="å‹ç¼©æ¨¡å¼">
                                <el-radio-group v-model="compressionSettings.lossless">
                                    <el-radio :value="false">æœ‰æŸå‹ç¼© (æ–‡ä»¶æ›´å°)</el-radio>
                                    <el-radio :value="true">æ— æŸå‹ç¼© (ä¿æŒè´¨é‡)</el-radio>
                                </el-radio-group>
                            </el-form-item>
                        </el-col>
                        
                        <el-col :span="12" v-if="!compressionSettings.lossless">
                            <el-form-item label="å‹ç¼©è´¨é‡">
                                <el-slider v-model="compressionSettings.quality"
                                          :min="10"
                                          :max="100"
                                          :step="5"
                                          show-input>
                                </el-slider>
                            </el-form-item>
                        </el-col>
                    </el-row>
                    
                    <el-button type="primary" 
                               size="large"
                               @click="startCompression"
                               :loading="isProcessing"
                               :disabled="selectedFiles.length === 0">
                        <span v-if="isProcessing">å¤„ç†ä¸­...</span>
                        <span v-else>å¼€å§‹å‹ç¼©</span>
                    </el-button>
                </div>
                
                <!-- è¿›åº¦æ˜¾ç¤º -->
                <div v-if="isProcessing" class="progress-section">
                    <h4>å¤„ç†è¿›åº¦</h4>
                    
                    <div v-for="(progress, index) in processingProgress" 
                         :key="index"
                         style="margin-bottom: 16px;">
                        <div style="margin-bottom: 8px;">
                            <span v-text="progress.fileName"></span>
                            <span style="float: right;" v-text="progress.status"></span>
                        </div>
                        
                        <el-progress :percentage="progress.percentage"
                                    :status="progress.status === 'å®Œæˆ' ? 'success' : 
                                            progress.status === 'é”™è¯¯' ? 'exception' : 'active'">
                        </el-progress>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ä¾èµ–åº“ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue/dist/index.iife.js"></script>
    
    <!-- å‰ç«¯æ–‡ä»¶å¤„ç†åº“ -->
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        const { UploadFilled } = ElementPlusIconsVue;

        createApp({
            data() {
                return {
                    selectedFiles: [],
                    isDragOver: false,
                    isProcessing: false,
                    processingProgress: [],
                    compressionSettings: {
                        lossless: false,
                        quality: 75
                    }
                };
            },
            
            methods: {
                // è§¦å‘æ–‡ä»¶é€‰æ‹©
                triggerFileSelect() {
                    this.$refs.fileInput.click();
                },
                
                // å¤„ç†æ–‡ä»¶é€‰æ‹©
                handleFileSelect(event) {
                    const files = Array.from(event.target.files);
                    this.addFiles(files);
                },
                
                // å¤„ç†æ‹–æ‹½
                handleDragOver(event) {
                    this.isDragOver = true;
                },
                
                handleDragLeave(event) {
                    this.isDragOver = false;
                },
                
                handleDrop(event) {
                    this.isDragOver = false;
                    const files = Array.from(event.dataTransfer.files);
                    this.addFiles(files);
                },
                
                // æ·»åŠ æ–‡ä»¶
                addFiles(files) {
                    const validFiles = files.filter(file => {
                        const ext = file.name.toLowerCase();
                        return ext.endsWith('.zip') || ext.endsWith('.cbz') || ext.endsWith('.cbr');
                    });
                    
                    if (validFiles.length !== files.length) {
                        ElMessage.warning('åªæ”¯æŒ ZIPã€CBZã€CBR æ ¼å¼çš„æ–‡ä»¶');
                    }
                    
                    this.selectedFiles.push(...validFiles);
                    
                    if (validFiles.length > 0) {
                        ElMessage.success(`å·²æ·»åŠ  ${validFiles.length} ä¸ªæ–‡ä»¶`);
                    }
                },
                
                // ç§»é™¤æ–‡ä»¶
                removeFile(index) {
                    this.selectedFiles.splice(index, 1);
                },
                
                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                
                // å¼€å§‹å‹ç¼©å¤„ç†
                async startCompression() {
                    if (this.selectedFiles.length === 0) {
                        ElMessage.warning('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                        return;
                    }

                    this.isProcessing = true;
                    this.processingProgress = this.selectedFiles.map(file => ({
                        fileName: file.name,
                        percentage: 0,
                        status: 'å‡†å¤‡ä¸­'
                    }));

                    try {
                        for (let i = 0; i < this.selectedFiles.length; i++) {
                            await this.processFile(this.selectedFiles[i], i);
                        }

                        ElMessage.success('æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆï¼');
                    } catch (error) {
                        console.error('å¤„ç†å¤±è´¥:', error);
                        ElMessage.error(`å¤„ç†å¤±è´¥: ${error.message}`);
                    } finally {
                        this.isProcessing = false;
                    }
                },

                // å¤„ç†å•ä¸ªæ–‡ä»¶
                async processFile(file, index) {
                    const progress = this.processingProgress[index];

                    try {
                        // æ­¥éª¤1: è¯»å–æ–‡ä»¶
                        progress.status = 'è¯»å–æ–‡ä»¶';
                        progress.percentage = 10;

                        const arrayBuffer = await this.readFileAsArrayBuffer(file);

                        // æ­¥éª¤2: è§£å‹ZIPæ–‡ä»¶
                        progress.status = 'è§£å‹æ–‡ä»¶';
                        progress.percentage = 20;

                        const zip = new JSZip();
                        const zipContent = await zip.loadAsync(arrayBuffer);

                        // æ­¥éª¤3: æå–å›¾ç‰‡æ–‡ä»¶
                        progress.status = 'æå–å›¾ç‰‡';
                        progress.percentage = 30;

                        const imageFiles = [];
                        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];

                        for (const [filename, fileData] of Object.entries(zipContent.files)) {
                            if (!fileData.dir) {
                                const ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));
                                if (imageExtensions.includes(ext)) {
                                    const imageBlob = await fileData.async('blob');
                                    imageFiles.push({
                                        name: filename,
                                        blob: imageBlob,
                                        originalSize: imageBlob.size
                                    });
                                }
                            }
                        }

                        if (imageFiles.length === 0) {
                            throw new Error('æœªæ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶');
                        }

                        // æ­¥éª¤4: è½¬æ¢å›¾ç‰‡æ ¼å¼
                        progress.status = 'è½¬æ¢å›¾ç‰‡';
                        progress.percentage = 40;

                        const convertedImages = [];
                        let totalOriginalSize = 0;
                        let totalCompressedSize = 0;

                        for (let i = 0; i < imageFiles.length; i++) {
                            const imageFile = imageFiles[i];
                            totalOriginalSize += imageFile.originalSize;

                            // æ›´æ–°è¿›åº¦
                            const imageProgress = 40 + (i / imageFiles.length) * 40;
                            progress.percentage = Math.round(imageProgress);
                            progress.status = `è½¬æ¢å›¾ç‰‡ ${i + 1}/${imageFiles.length}`;

                            const convertedBlob = await this.convertImageToWebP(imageFile.blob);
                            totalCompressedSize += convertedBlob.size;

                            // ç”Ÿæˆæ–°çš„æ–‡ä»¶å
                            const baseName = imageFile.name.substring(0, imageFile.name.lastIndexOf('.'));
                            const newName = baseName + '.webp';

                            convertedImages.push({
                                name: newName,
                                blob: convertedBlob
                            });
                        }

                        // æ£€æŸ¥å‹ç¼©æ•ˆæœ
                        const compressionRatio = (totalOriginalSize - totalCompressedSize) / totalOriginalSize;
                        console.log(`å‹ç¼©æ•ˆæœ: ${(compressionRatio * 100).toFixed(1)}% (${this.formatFileSize(totalOriginalSize)} â†’ ${this.formatFileSize(totalCompressedSize)})`);

                        // æ­¥éª¤5: é‡æ–°æ‰“åŒ…
                        progress.status = 'æ‰“åŒ…æ–‡ä»¶';
                        progress.percentage = 85;

                        const newZip = new JSZip();

                        // æ·»åŠ è½¬æ¢åçš„å›¾ç‰‡
                        for (const image of convertedImages) {
                            newZip.file(image.name, image.blob);
                        }

                        // æ­¥éª¤6: ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶
                        progress.status = 'ç”Ÿæˆæ–‡ä»¶';
                        progress.percentage = 95;

                        const finalBlob = await newZip.generateAsync({
                            type: 'blob',
                            compression: 'DEFLATE',
                            compressionOptions: { level: 6 }
                        });

                        // æ­¥éª¤7: ä¸‹è½½æ–‡ä»¶
                        progress.status = 'ä¸‹è½½æ–‡ä»¶';
                        progress.percentage = 100;

                        const originalName = file.name.substring(0, file.name.lastIndexOf('.'));
                        const newFileName = `${originalName}_compressed_webp.zip`;

                        // ä½¿ç”¨FileSaver.jsä¸‹è½½æ–‡ä»¶
                        saveAs(finalBlob, newFileName);

                        progress.status = 'å®Œæˆ';

                        // æ˜¾ç¤ºå‹ç¼©ç»Ÿè®¡
                        ElMessage.success(`${file.name} å¤„ç†å®Œæˆï¼å‹ç¼©ç‡: ${(compressionRatio * 100).toFixed(1)}%`);

                    } catch (error) {
                        progress.status = 'é”™è¯¯';
                        progress.percentage = 0;
                        throw new Error(`å¤„ç† ${file.name} æ—¶å‡ºé”™: ${error.message}`);
                    }
                },

                // è¯»å–æ–‡ä»¶ä¸ºArrayBuffer
                readFileAsArrayBuffer(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                        reader.readAsArrayBuffer(file);
                    });
                },

                // è½¬æ¢å›¾ç‰‡ä¸ºWebPæ ¼å¼
                async convertImageToWebP(imageBlob) {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        img.onload = () => {
                            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                            canvas.width = img.width;
                            canvas.height = img.height;

                            // ç»˜åˆ¶å›¾ç‰‡
                            ctx.drawImage(img, 0, 0);

                            // è½¬æ¢ä¸ºWebP
                            const quality = this.compressionSettings.lossless ? 1.0 : this.compressionSettings.quality / 100;
                            const mimeType = this.compressionSettings.lossless ? 'image/webp' : 'image/webp';

                            canvas.toBlob((blob) => {
                                if (blob) {
                                    resolve(blob);
                                } else {
                                    reject(new Error('å›¾ç‰‡è½¬æ¢å¤±è´¥'));
                                }
                            }, mimeType, quality);
                        };

                        img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                        img.src = URL.createObjectURL(imageBlob);
                    });
                }
            }
        }).use(ElementPlus).component('UploadFilled', UploadFilled).mount('#app');
    </script>
</body>
</html>
